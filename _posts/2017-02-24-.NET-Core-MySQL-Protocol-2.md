---
layout: default
title: MySQL协议.NET Core实现(二)
---

在上周的[MySQL协议.NET Core实现(一)](http://www.xyting.org/2017/02/18/.NET-Core-MySql-Protocol-1.html)文章中，我们分析了MySQL协议，并使用.NET Core实现了MySQL协议的基本类型，今天，我们花一些时间实现异步Socket，以及MySQL的服务器端到客户端的握手初始化消息。

# 基础知识

## 深入理解Async/Await

我们用得很爽的C# 5 **Async/Await**语法特性，极大地简化了异步编程，但我们都很清楚**异步编程**的基础理论并没有变，其复杂度仍然在哪里。也就是说，当一些复杂的东西看起来很简单时，它通常意味着有一些有趣的事情在背后发生。我们把这些本身很复杂但看起来很简单的东西称为*语法糖*，通常情况下，我们并不需要深入理解*语法糖*是怎么被一层一层包裹起来的，但在这里，我们需要知道**Async/Await**背后到底发上了什么？

## 三种返回类型，一种思想

我们知道，异步方法仅限于三个不同的返回类型︰

- void
- Task
- Task<T>

而C#编译器在编译这些异步方法时，还需要三个Builder：

- AsyncVoidMethodBuilder
- AsyncTaskMethodBuilder
- AsyncTaskMethodBuilder<T>

这三个Builder大部分都是一样的：

```csharp
public struct AsyncVoidMethodBuilder 
    { 
        public static AsyncVoidMethodBuilder Create() 
        { 
            return new AsyncVoidMethodBuilder(); 
        }

        public void AwaitOnCompleted<TAwaiter, TStateMachine>(ref TAwaiter awaiter,ref TStateMachine stateMachine)
            where TAwaiter : INotifyCompletion
            where TStateMachine : IAsyncStateMachine 
            {

            }

            public void SetStateMachine(IAsyncStateMachine stateMachine) {}

            public void Start<TStateMachine>(ref TStateMachine stateMachine)
            where TStateMachine : IAsyncStateMachine
            {

            }

        public void SetException(Exception e) {} 
        public void SetResult() {} 
    }

    public struct AsyncTaskMethodBuilder 
    { 
        public static AsyncTaskMethodBuilder Create() 
        { 
            return new AsyncTaskMethodBuilder(); 
        }

        public void SetException(Exception e) {} 
        public void SetResult() {} 
        public Task Task { get { return null; } } 
    }

    public struct AsyncTaskMethodBuilder<T> 
    { 
        public static AsyncTaskMethodBuilder<T> Create() 
        { 
            return new AsyncTaskMethodBuilder<T>(); 
        }

        public void SetException(Exception e) {} 
        public void SetResult(T result) {} 
        public Task<T> Task { get { return null; } } 
    } 
```

## Awaitables and Awaiters